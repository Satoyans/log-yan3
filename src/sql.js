"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.queryAsync = exports.query = void 0;
const event_2 = require("bdsx/event");
const mysql = require("mysql");
const dotenv_1 = require("dotenv");
const path = require("path");
(0, dotenv_1.config)({ path: path.join(__dirname, ".env") });
const connection = mysql.createConnection({
    host: 'localhost',
    user: 'root',
    password: process.env.SQL_PASSWORD,
    database: process.env.SQL_DATABASE
});
function query(queryText, func) {
    try {
        //deleteOldLog();
        connection.query(queryText, func);
    }
    catch (e) {
        console.error(e);
    }
    ;
}
exports.query = query;
function queryAsync(queryText) {
    return new Promise((resolve, reject) => {
        try {
            connection.query(queryText, (err, result, field) => {
                if (err == null) {
                    resolve(result);
                }
                else {
                    reject(err);
                }
            });
        }
        catch (e) {
            console.error(e);
        }
        ;
    });
}
exports.queryAsync = queryAsync;
var lastDelTime = new Date().getTime();
const time_to_delete = 3 * 30 * 24 * 60 * 60 * 1000; //3 month
const deleteOldLog = () => {
    if ((new Date().getTime() - lastDelTime) < 15 * 60 * 1000)
        return;
    let timeobj = new Date(new Date().getTime() - time_to_delete);
    let timestr = `${timeobj.getFullYear()}-${('0' + (Number(timeobj.getMonth()) + 1)).slice(-2)}-${('0' + timeobj.getDate()).slice(-2)} ${('0' + timeobj.getHours()).slice(-2)}:${('0' + timeobj.getMinutes()).slice(-2)}:${('0' + timeobj.getSeconds()).slice(-2)}`;
    console.log("[Log-Yan]ログの削除を実行します。");
    console.log("～" + timestr + "(" + (new Date().getTime() - lastDelTime) / 1000 / 60 + ")分");
    lastDelTime = new Date().getTime();
    for (let table of ["blockcontainer", "blockdestroy", "blockinteractedwith", "blockplace", "entitydie", "itemthrow", "playerattack"]) {
        //not delete table (getElytra/lightningHitBlock)
        connection.query("DELETE FROM `logyan`.`" + table + "` WHERE `time` < '" + timestr + "';");
    }
};
event_2.events.serverClose.on(() => {
    connection.destroy();
});
(function handleDisconnect() {
    connection.connect((err) => {
        if (err) {
            console.log('ERROR.CONNECTION_DB: ', err);
            setTimeout(() => { handleDisconnect; }, 1000);
        }
    });
    //error('PROTOCOL_CONNECTION_LOST')時に再接続
    connection.on('error', (err) => {
        console.log('ERROR.DB: ', err);
        if (err.code === 'PROTOCOL_CONNECTION_LOST') {
            console.log('ERROR.CONNECTION_LOST'.yellow);
            handleDisconnect();
        }
        else {
            throw err;
        }
    });
})();
event_2.events.serverClose.on(() => {
    connection.destroy();
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3FsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic3FsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHNDQUFvQztBQUNwQywrQkFBK0I7QUFDL0IsbUNBQThCO0FBQzlCLDZCQUE2QjtBQUM3QixJQUFBLGVBQU0sRUFBQyxFQUFDLElBQUksRUFBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBQyxNQUFNLENBQUMsRUFBQyxDQUFDLENBQUM7QUFFM0MsTUFBTSxVQUFVLEdBQUcsS0FBSyxDQUFDLGdCQUFnQixDQUFDO0lBQ3RDLElBQUksRUFBRSxXQUFXO0lBQ2pCLElBQUksRUFBRSxNQUFNO0lBQ1osUUFBUSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWTtJQUNsQyxRQUFRLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZO0NBQ3JDLENBQUMsQ0FBQztBQUVILFNBQVMsS0FBSyxDQUFDLFNBQWlCLEVBQUUsSUFBVTtJQUN4QyxJQUFJO1FBQ0EsaUJBQWlCO1FBQ2pCLFVBQVUsQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO0tBQ3JDO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFBRSxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBO0tBQUU7SUFBQSxDQUFDO0FBQ3JDLENBQUM7QUE0REcsc0JBQUs7QUEzRFQsU0FBUyxVQUFVLENBQUMsU0FBaUI7SUFDakMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtRQUNuQyxJQUFJO1lBQ0EsVUFBVSxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQyxHQUE0QixFQUFFLE1BQVcsRUFBRSxLQUFvQyxFQUFFLEVBQUU7Z0JBQzVHLElBQUksR0FBRyxJQUFJLElBQUksRUFBRTtvQkFDYixPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7aUJBQ25CO3FCQUFNO29CQUNILE1BQU0sQ0FBQyxHQUFHLENB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